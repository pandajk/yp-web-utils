"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=CreateVirtualShelf;var _ImagePreloader=_interopRequireDefault(require("./ImagePreloader.js"));function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}class VirtualShelf{constructor(cargolist,TemplateID=1){this.cargolist=cargolist;this.TemplateID=TemplateID;this.PRESET_TEMPLATE_CONFIG=[null,{PAGE_SIZE:30,PAGE_ROW:3,ROW_SIZE:10},{PAGE_SIZE:28,PAGE_ROW:2,ROW_SIZE:14},{PAGE_SIZE:0,PAGE_ROW:1,ROW_SIZE:1},null]}async init(){const Products=await this.uniqueProduct();const ProductLayout=[];if(this.TemplateID===3){ProductLayout.push({title:`货架`,layout:[Products.ProductList]})}else{const layout=this.pagingProducts(Products);layout.map((el,i)=>{ProductLayout.push({title:`货架${i+1}`,layout:el})})}return ProductLayout}uniqueProduct(){const ProductMap=new Map;let ProductList=[];let ColTotal=0;let ColSpanArray=[null,[],[]];this.cargolist.map(el=>{ProductMap.set(el.BarCode,el)});ProductList=Array.from(ProductMap.values());const loaders=ProductList.map(el=>{ColTotal+=el.ColSpan;if(ColSpanArray[el.ColSpan]){ColSpanArray[el.ColSpan].push(el)}return new Promise((resolve,reject)=>{const loader=new _ImagePreloader.default(el.ImageFixWidthUrl,{suffix:"?x-oss-process=image/resize,p_1"});loader.loadImage().then(image=>{setImageInfo(el,image);resolve()}).catch(err=>{el.ImageFixWidthUrl="";console.log("reject-1",err);resolve()})})});return new Promise(resolve=>{Promise.all(loaders).then(()=>{resolve({ProductList,ColTotal,ColSpanArray})})})}pagingProducts({ProductList,ColTotal,ColSpanArray}){const{PRESET_TEMPLATE_CONFIG,TemplateID}=this;const{PAGE_SIZE,PAGE_ROW,ROW_SIZE}=PRESET_TEMPLATE_CONFIG[TemplateID];const screens=Math.ceil(ColTotal/PAGE_SIZE);const remainderPercent=ColTotal%PAGE_SIZE/PAGE_SIZE;const ColSpan1Size=Math.ceil(ColSpanArray[1].length/screens);const ColSpan2Size=Math.ceil(ColSpanArray[2].length/screens);let overflow=0;const layout=new Array(screens).fill().map((el,page)=>{const ColTotal=ColSpan1.length+ColSpan2.length*2;let ColSpan1=[];let ColSpan2=[];if(ColTotal>PAGE_SIZE){ColSpan2=ColSpanArray[2].splice(0,ColSpan2Size);ColSpan1=ColSpanArray[1].splice(0,PAGE_SIZE-ColSpan2Size*2);overflow=ColTotal-PAGE_SIZE}else{if(overflow>0){ColSpan2=ColSpanArray[2].splice(0,ColSpan2Size);const remainder=PAGE_SIZE-ColSpan2Size*2;ColSpan1=ColSpanArray[1].splice(0,remainder);overflow-=ColSpan1.length-ColSpan1Size}else{ColSpan1=ColSpanArray[1].splice(0,ColSpan1Size);ColSpan2=ColSpanArray[2].splice(0,ColSpan2Size)}}return this.pileUpProducts({ColTotal,ColSpanArray:[null,ColSpan1,ColSpan2]})});return layout}pileUpProducts({ColTotal,ColSpanArray}){const{PRESET_TEMPLATE_CONFIG,TemplateID}=this;const{PAGE_SIZE,PAGE_ROW,ROW_SIZE}=PRESET_TEMPLATE_CONFIG[TemplateID];if(!PAGE_SIZE)return;const screen=new Array(PAGE_ROW).fill().map(el=>[]);const columns=new Array(PAGE_ROW).fill(0);const repeat=Math.floor(PAGE_SIZE/ColTotal);let overflow=PAGE_SIZE-repeat*ColTotal;let stack=PAGE_SIZE;let ColSpan1=ColSpanArray[1].sort((a,b)=>{return a.ImageHeight-b.ImageHeight});let ColSpan2=ColSpanArray[2].sort((a,b)=>{return a.ImageHeight-b.ImageHeight});const ColSpanLength=[ColSpan1.length,ColSpan2.length];let ColSpanCount=[new Array(ColSpanLength[0]).fill(repeat),new Array(ColSpanLength[1]).fill(repeat)];let indicator=[0,0];let loop=0;const fillRemainderSpace=()=>{if(overflow<=0)return;if(isNaN(overflow))return;loop+=1;let idx=loop%2;let ColSpan=idx+1;if(overflow>=ColSpan&&indicator[idx]<ColSpanLength[idx]){ColSpanCount[idx][indicator[idx]]+=1;indicator[idx]+=1;overflow-=ColSpan}fillRemainderSpace()};fillRemainderSpace();const ColSpan=[ColSpan2,ColSpan1];ColSpanCount.reverse().map((group,i)=>{const ColSpanReverse=ColSpan[i].reverse();group.reverse().map((count,k)=>{for(let time=0;time<count;time++){_pushItem(ColSpanReverse[k])}})});function _pushItem(elem,repeat){for(let row=0;row<PAGE_ROW;row++){if(columns[row]<ROW_SIZE){screen[row].push(Object.assign({},elem,{RowIndex:row,ColumnIndex:columns[row]}));columns[row]+=elem.ColSpan;break}}}screen.reverse().map(row=>{row.reverse()});return screen}}async function CreateVirtualShelf(cargolist,TemplateID=1){return new VirtualShelf(cargolist,TemplateID).init()}function setImageInfo(el,image){el["ImageWidth"]=95*image.width/750/0.4;el["ImageHeight"]=95*image.height/750/0.4;el["ImageOriginWidth"]=image.width/0.4;el["ImageOriginHeight"]=image.height/0.4}